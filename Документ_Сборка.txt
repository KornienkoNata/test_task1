
Процедура ОбработкаПроведения(Отказ, Режим)
	
	// регистр ОстаткиНоменклатуры Приход
	Движения.ОстаткиНоменклатуры.Записывать = Истина;
	Для Каждого ТекСтрокаДетали Из Детали Цикл
		Движение = Движения.ОстаткиНоменклатуры.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Номенклатура = ТекСтрокаДетали.Деталь;
		Движение.Подразделения = ПодразделениеПриход;
		Движение.Количество = ТекСтрокаДетали.Количество;
	КонецЦикла;
	Движения.Записать();
	
	//Здесь контроль остатков -----------------------------------------------------
		    	
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	ОстаткиНоменклатурыОстатки.Номенклатура,
			|	ОстаткиНоменклатурыОстатки.Подразделения,
			|	ОстаткиНоменклатурыОстатки.КоличествоОстаток
			|ИЗ
			|	РегистрНакопления.ОстаткиНоменклатуры.Остатки(
			|			,
			|			Подразделения = &Подразделение
			|				И Номенклатура В       	
			|					(ВЫБРАТЬ
			|						СборкаДетали.Деталь
			|					ИЗ
			|						Документ.Сборка.Детали КАК СборкаДетали
			|					ГДЕ
			|						СборкаДетали.Ссылка = &Ссылка)) КАК ОстаткиНоменклатурыОстатки
			|ГДЕ
			|	ОстаткиНоменклатурыОстатки.КоличествоОстаток < 0";
		
		Запрос.УстановитьПараметр("Подразделение", ПодразделениеПриход);
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		
		РезультатЗапроса = Запрос.Выполнить();
		Если НЕ РезультатЗапроса.Пустой() Тогда
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				Сообщить("Недостаточно деталей: " + ВыборкаДетальныеЗаписи.Номенклатура + " в количестве  " + ВыборкаДетальныеЗаписи.КоличествоОстаток); 
			КонецЦикла;	
			Отказ = Истина;
		 КонецЕсли;
	 
	//Узнаем какой метод списания у данного подразделения-----------------------
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	МетодСписанияТоваров.МетодСписания
		|ИЗ
		|	РегистрСведений.МетодСписанияТоваров КАК МетодСписанияТоваров
		|ГДЕ
		|	МетодСписанияТоваров.Подразделение = &Подразделение";
	
	Запрос.УстановитьПараметр("Подразделение", ПодразделениеПриход);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
	    Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не указан метод списания! Проведение не возможно";
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	ВыборкаДетальныеЗаписи.Следующий();
	МетодСписания = 	ВыборкаДетальныеЗаписи.МетодСписания;	

	//Спишем детали с нужного подразделения по среднему-------------------------------	
	Если МетодСписания = Справочники.МетодыСписания.НайтиПоКоду("000000003") Тогда
		Если НЕ Отказ Тогда
			СуммаСистемногоБлока =0;	
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	СебестоимостьДеталейОстатки.Деталь,
				|	СебестоимостьДеталейОстатки.СуммаОстаток КАК Сумма,
				|	СебестоимостьДеталейОстатки.КоличествоОстаток КАК Количество
				|ИЗ
				|	РегистрНакопления.СебестоимостьДеталей.Остатки(
				|			&МоментВремени,
				|			Подразделение = &ПодразделениеПриход
				|				И Деталь В
				|					(ВЫБРАТЬ
				|						СборкаДетали.Деталь
				|					ИЗ
				|						Документ.Сборка.Детали КАК СборкаДетали
				|					ГДЕ
				|						СборкаДетали.Ссылка = &Ссылка)) КАК СебестоимостьДеталейОстатки";
			
			Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
			Запрос.УстановитьПараметр("Ссылка", Ссылка);
			Запрос.УстановитьПараметр("ПодразделениеПриход", ПодразделениеПриход);
			РезультатЗапроса = Запрос.Выполнить();
			
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
			
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				Если ВыборкаДетальныеЗаписи.Количество>0 Тогда
					СебестоимостьЕдиницы =ВыборкаДетальныеЗаписи.Сумма/ВыборкаДетальныеЗаписи.Количество;     //по среднему
				КонецЕсли;
				
				Движения.СебестоимостьДеталей.Записывать = Истина;
				
				Движение = Движения.СебестоимостьДеталей.Добавить();
				Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
				Движение.Период = Дата;
				
				СтрокаТЧ = Детали.Найти(ВыборкаДетальныеЗаписи.Деталь, "Деталь");
				
				Движение.Деталь = ВыборкаДетальныеЗаписи.Деталь;
				Движение.Подразделение = ПодразделениеПриход; //Откуда пришли детали
				Движение.Количество = СтрокаТЧ.Количество;
				Движение.Сумма = СебестоимостьЕдиницы *СтрокаТЧ.Количество; ;		
				Движение.Себестоимость = СебестоимостьЕдиницы ;		
				//Найдем себестоимость системного блока
				СуммаСистемногоБлока =СуммаСистемногоБлока + Движение.Сумма;
			КонецЦикла;		
		
		КонецЕсли;
	КонецЕсли;	
	//Fifo   ----------------------------
	Если МетодСписания = Справочники.МетодыСписания.НайтиПоКоду("000000001") Тогда
		   Если НЕ Отказ Тогда
			СуммаСистемногоБлока =0;	
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	СебестоимостьДеталей.МоментВремени,
				|	СебестоимостьДеталей.Деталь,
				|	СебестоимостьДеталей.Сумма КАК СуммаПрихода,
				|	СебестоимостьДеталей.Количество КАК КоличествоПрихода
				|ПОМЕСТИТЬ ВсеПриходы
				|ИЗ
				|	РегистрНакопления.СебестоимостьДеталей КАК СебестоимостьДеталей
				|ГДЕ
				|	СебестоимостьДеталей.Подразделение = &Подразделение
				|	И СебестоимостьДеталей.Деталь В
				|			(ВЫБРАТЬ
				|				СборкаДетали.Деталь
				|			ИЗ
				|				Документ.Сборка.Детали КАК СборкаДетали
				|			ГДЕ
				|				СборкаДетали.Ссылка = &Ссылка)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	СборкаДетали.Деталь КАК Деталь,
				|	СборкаДетали.Количество КАК КоличествоВСборке,
				|	ВсеПриходы.СуммаПрихода / ВсеПриходы.КоличествоПрихода КАК СуммаПрихода,
				|	ВсеПриходы.КоличествоПрихода
				|ИЗ
				|	ВсеПриходы КАК ВсеПриходы
				|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Сборка.Детали КАК СборкаДетали
				|		ПО (СборкаДетали.Деталь = ВсеПриходы.Деталь)
				|
				|УПОРЯДОЧИТЬ ПО
				|	ВсеПриходы.МоментВремени
				|ИТОГИ
				|	МАКСИМУМ(КоличествоВСборке),
				|	СУММА(СуммаПрихода)
				|ПО
				|	Деталь";
						
			Запрос.УстановитьПараметр("Ссылка", Ссылка);
			Запрос.УстановитьПараметр("Подразделение", ПодразделениеПриход);
			РезультатЗапроса = Запрос.Выполнить();
			
			ВыборкаНоменклатура = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "Деталь");
			
			Пока ВыборкаНоменклатура.Следующий() Цикл
				ВыборкаДетальныеЗаписи = ВыборкаНоменклатура.Выбрать(); //Выбрали одну группировку, например по CoreI7
				    ВыборкаДетальныеЗаписи.Следующий(); 
					СебестоимостьЕдиницы =0;
					
					Если ВыборкаДетальныеЗаписи.КоличествоВСборке<=ВыборкаДетальныеЗаписи.КоличествоПрихода Тогда
						 СебестоимостьЕдиницы = ВыборкаДетальныеЗаписи.СуммаПрихода; 
					Иначе						
					ДеталейВсего =0;						 
					Пока ДеталейВсего<ВыборкаДетальныеЗаписи.КоличествоВСборке Цикл
						Для Индекс = 1 По ВыборкаДетальныеЗаписи.КоличествоПрихода Цикл				
							   СебестоимостьЕдиницы =СебестоимостьЕдиницы+ВыборкаДетальныеЗаписи.СуммаПрихода;
							   ДеталейВсего = ДеталейВсего + 1;
							   Если ДеталейВсего = ВыборкаДетальныеЗаписи.КоличествоВСборке Тогда Прервать; КонецЕсли;
							   ВыборкаДетальныеЗаписи.Следующий(); 
						КонецЦикла;						
						
					КонецЦикла;	
				КонецЕсли;	  
				    СебестоимостьЕдиницы =СебестоимостьЕдиницы/ВыборкаНоменклатура.КоличествоВСборке;     
					
					Движения.СебестоимостьДеталей.Записывать = Истина;
						
					Движение = Движения.СебестоимостьДеталей.Добавить();
					Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
					Движение.Период = Дата;
						
					СтрокаТЧ = Детали.Найти(ВыборкаНоменклатура.Деталь, "Деталь");
						
					Движение.Деталь = ВыборкаНоменклатура.Деталь;
					Движение.Подразделение = ПодразделениеПриход; //Откуда пришли детали
					Движение.Количество = СтрокаТЧ.Количество;
					Движение.Себестоимость = СебестоимостьЕдиницы ;		
					Движение.Сумма = СебестоимостьЕдиницы *СтрокаТЧ.Количество; ;		
				    СуммаСистемногоБлока =СуммаСистемногоБлока + Движение.Сумма;
			КонецЦикла;		
		
		КонецЕсли;
		
	КонецЕсли;	
	 //LIFO ----------------------------------------- можно было просто кусок запроса в fifo изменить
	Если МетодСписания = Справочники.МетодыСписания.НайтиПоКоду("000000002") Тогда
		      Если НЕ Отказ Тогда
			СуммаСистемногоБлока =0;	
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	СебестоимостьДеталей.МоментВремени,
				|	СебестоимостьДеталей.Деталь,
				|	СебестоимостьДеталей.Сумма КАК СуммаПрихода,
				|	СебестоимостьДеталей.Количество КАК КоличествоПрихода
				|ПОМЕСТИТЬ ВсеПриходы
				|ИЗ
				|	РегистрНакопления.СебестоимостьДеталей КАК СебестоимостьДеталей
				|ГДЕ
				|	СебестоимостьДеталей.Подразделение = &Подразделение
				|	И СебестоимостьДеталей.Деталь В
				|			(ВЫБРАТЬ
				|				СборкаДетали.Деталь
				|			ИЗ
				|				Документ.Сборка.Детали КАК СборкаДетали
				|			ГДЕ
				|				СборкаДетали.Ссылка = &Ссылка)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	СборкаДетали.Деталь КАК Деталь,
				|	СборкаДетали.Количество КАК КоличествоВСборке,
				|	ВсеПриходы.СуммаПрихода / ВсеПриходы.КоличествоПрихода КАК СуммаПрихода,
				|	ВсеПриходы.КоличествоПрихода
				|ИЗ
				|	ВсеПриходы КАК ВсеПриходы
				|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.Сборка.Детали КАК СборкаДетали
				|		ПО (СборкаДетали.Деталь = ВсеПриходы.Деталь)
				|
				|УПОРЯДОЧИТЬ ПО
				|	ВсеПриходы.МоментВремени УБЫВ
				|ИТОГИ
				|	МАКСИМУМ(КоличествоВСборке),
				|	СУММА(СуммаПрихода)
				|ПО
				|	Деталь";
						
			Запрос.УстановитьПараметр("Ссылка", Ссылка);
			Запрос.УстановитьПараметр("Подразделение", ПодразделениеПриход);
			РезультатЗапроса = Запрос.Выполнить();
			
			ВыборкаНоменклатура = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "Деталь");
			
			Пока ВыборкаНоменклатура.Следующий() Цикл
				ВыборкаДетальныеЗаписи = ВыборкаНоменклатура.Выбрать(); //Выбрали одну группировку, например по CoreI7
				    ВыборкаДетальныеЗаписи.Следующий(); 
					СебестоимостьЕдиницы =0;
					
					Если ВыборкаДетальныеЗаписи.КоличествоВСборке<=ВыборкаДетальныеЗаписи.КоличествоПрихода Тогда
						 СебестоимостьЕдиницы = ВыборкаДетальныеЗаписи.СуммаПрихода; 
					Иначе						
					ДеталейВсего =0;						 
					Пока ДеталейВсего<ВыборкаДетальныеЗаписи.КоличествоВСборке Цикл
						Для Индекс = 1 По ВыборкаДетальныеЗаписи.КоличествоПрихода Цикл				
							   СебестоимостьЕдиницы =СебестоимостьЕдиницы+ВыборкаДетальныеЗаписи.СуммаПрихода;
							   ДеталейВсего = ДеталейВсего + 1;
							   Если ДеталейВсего = ВыборкаДетальныеЗаписи.КоличествоВСборке Тогда Прервать; КонецЕсли;
							   ВыборкаДетальныеЗаписи.Следующий(); 
						КонецЦикла;						
						
					КонецЦикла;	
				КонецЕсли;	  
				    СебестоимостьЕдиницы =СебестоимостьЕдиницы/ВыборкаНоменклатура.КоличествоВСборке;     
					
					Движения.СебестоимостьДеталей.Записывать = Истина;
						
					Движение = Движения.СебестоимостьДеталей.Добавить();
					Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
					Движение.Период = Дата;
						
					СтрокаТЧ = Детали.Найти(ВыборкаНоменклатура.Деталь, "Деталь");
						
					Движение.Деталь = ВыборкаНоменклатура.Деталь;
					Движение.Подразделение = ПодразделениеПриход; //Откуда пришли детали
					Движение.Количество = СтрокаТЧ.Количество;
					Движение.Себестоимость = СебестоимостьЕдиницы ;		
					Движение.Сумма = СебестоимостьЕдиницы *СтрокаТЧ.Количество; ;		
					
				    СуммаСистемногоБлока =СуммаСистемногоБлока + Движение.Сумма;
			КонецЦикла;		
		
		КонецЕсли;
		
	КонецЕсли;	
	
	//Готовый системные блоки поступают в офис "ПодразделениеРасход". ----------------------------
										
	Движение = Движения.СебестоимостьДеталей.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
	Движение.Период = Дата;
	Движение.Деталь = СистемныйБлок;
	Движение.Подразделение = ПодразделениеРасход; 	
	Движение.Сумма = СуммаСистемногоБлока *Количество;
	Движение.Себестоимость = СуммаСистемногоБлока ;		
	Движение.Количество = Количество;
	
	
КонецПроцедуры
